<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - To-Do List</title>
    <link rel="icon" type="image/png" href="logo.png">
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="backStar.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="sb.js"></script>
</head>
<style>
     body {
   
    background: radial-gradient(ellipse at bottom, #0d1d31 0%,#0d1d31);
  
}

#loadingSpinner {
    position: fixed;  /* Fix the spinner to the screen */
    top: 50%;         /* Center vertically */
    left: 50%;        /* Center horizontally */
   
    z-index: 9999;    /* Ensure it's on top of other content */
}
/* Switch styles */
.switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 20px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 15px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #ffc107; /* Set color for the 'Important' state */
}

input:checked + .slider:before {
    transform: translateX(14px);
}
.hide{
    display:none;
}
</style>
<body>
    
    <div class="container mt-1 text-light">
        <div class="card text-bg-primary mb-2">
            <!-- Button to Open Modal -->     
           <div class="card-header d-flex justify-content-between align-items-center">
             <!-- Back Button with Icon -->
             <a href="#" class="btn btn-lg btn-outline-light me-2 scroll" style="border-radius: 50px;" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
             </a>
                <!-- Notes Count Display -->
               <h5 class="mt-1">Notes</h5>
               <button id="logoutButton" class="btn btn-light" style="border-radius: 70px; font-size: small;">Log Out</button>
           </div>
        </div>
        
         <!-- Add Note Button with Icon -->
         <button id="openModalBtn" class="btn btn-outline-light" style="border-radius: 20px;">
         <i class="fas fa-plus"></i> Add Note
         </button>

        <!-- Important Filter Button with Icon -->
        <button id="importantFilterBtn" class="btn btn-outline-warning" style="border-radius: 20px;">
        <i class="fas fa-star"></i> Important
        </button>
        <P class="mt-1">Your Notes [<span class="text-light" id="noteCount">0</span>]</P>

        
        <!-- Search Input for Notes -->
           <!-- Search Filter Section -->
        <div class="mb-2">
            <div class="input-group zoom mb-2">
                <span class="input-group-text" id="searchIcon">
                    <i class="fas fa-search"></i>
                </span>
                <input id="searchInput" class="form-control" type="text" placeholder="Search notes...">
            </div>
            
        </div>
        
       
        <ul id="notesList" class="list-group mt-3"></ul>
        
        <!-- Modal for Adding/Editing Note -->
        <div class="modal fade glass" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content text-dark">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addNoteModalLabel">Add New Note</h5>
                
                    </div>
                    <div class="modal-body">
                        <textarea id="modalNoteInput" class="form-control" rows="10" placeholder="Write your note..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button id="saveNoteBtn" type="button" class="btn btn-primary">Save Note</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Previewing Note -->
        <div class="modal fade glass" id="previewNoteModal" tabindex="-1" aria-labelledby="previewNoteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content text-dark">
                    <div class="modal-header">
                        <h5 class="modal-title" id="previewNoteModalLabel">Note Preview</h5>
                        
                    </div>
                    <div class="modal-body">
                        <div id="previewNoteContent"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

       <!-- Loading Spinner -->
<div id="loadingSpinner" class="spinner-border text-light mt-3" style="display: none;" role="status">
</div>


    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        const notesList = document.getElementById("notesList");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const noteCount = document.getElementById("noteCount");
        const searchInput = document.getElementById("searchInput");
        const importantFilterBtn = document.getElementById("importantFilterBtn");


        let editNoteId = null; // Track note being edited
        let notesArray = [];   // Store all notes for filtering
        let showOnlyImportant = false; // Track if important filter is active

        // Show modal for adding a new note
        document.getElementById("openModalBtn").addEventListener("click", () => {
            editNoteId = null;  // Reset editNoteId for new note
            document.getElementById("modalNoteInput").value = "";  // Clear modal input
            $('#addNoteModal').modal('show');
        });

        // Save note or update edited note
        document.getElementById("saveNoteBtn").addEventListener("click", () => {
            const noteText = document.getElementById("modalNoteInput").value;
            if (noteText.trim() !== "") {
                const userId = firebase.auth().currentUser.uid;
                const notesRef = firebase.database().ref("notes/" + userId);
                const currentDate = new Date().toISOString();

                if (editNoteId) {
                    // Update existing note
                    notesRef.child(editNoteId).update({ text: noteText });
                } else {
                    // Add new note
                    notesRef.push().set({
                        text: noteText,
                        date: currentDate
                    });
                }

                $('#addNoteModal').modal('hide');
            } else {
                alert("Please enter some text for the note.");
            }
        });

       // Toggle the important filter
          importantFilterBtn.addEventListener("click", () => {
          showOnlyImportant = !showOnlyImportant;

       // Update button text and icon based on the filter state
        importantFilterBtn.innerHTML = showOnlyImportant 
        ? '<i class="fas fa-list"></i> All Notes' 
        : '<i class="fas fa-star"></i> Important';
        //? '<i class="fas fa-list"></i>' 
        //: '<i class="fas fa-star"></i>';

         renderNotes(); // Re-render notes based on the current filter
        });


         // Updated renderNotes function with important notes filtering
         function renderNotes(filter = "") {
            notesList.innerHTML = ""; // Clear notes list
            const filteredNotes = notesArray.filter(note => {
                const noteText = note.val().text.toLowerCase();
                const matchesSearch = noteText.includes(filter.toLowerCase());
                const isImportant = note.val().important;
                return matchesSearch && (!showOnlyImportant || isImportant);
            });

            noteCount.textContent = filteredNotes.length; // Update notes count

            // Render each filtered note
            filteredNotes.forEach((childSnapshot) => {
                const noteData = childSnapshot.val();
                const noteId = childSnapshot.key;
                const noteDate = new Date(noteData.date).toLocaleString();

                const listItem = document.createElement("li");
                listItem.classList.add("group-item");
                if (noteData.important) listItem.classList.add("important-note");

                listItem.innerHTML = `
                    <div class="glass zoom mb-2">
            <div class="text-right mb-1" style="margin-right: 20px;">
                <span>Important</span>
                <label class="switch">
                    <input type="checkbox" class="important-checkbox" ${noteData.important ? "checked" : ""}>
                    <span class="slider round"></span>
                </label>
                <button class="btn btn-secondary btn-sm mr-2 copy-btn">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-success btn-sm share-btn hide">
                    <i class="fas fa-share-alt"></i>
                </button>
                <!-- Dropdown Menu Section -->
                <span class="dropleft mb-2">
                    <a type="button" class="btn btn-sm btn-danger" data-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end text-center" aria-labelledby="dropdownMenuLink">
                        <li>
                            <button class="btn btn-sm btn-light edit-btn d-block w-100 mb-1">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </li>
                        <li>
                            <button class="btn btn-sm btn-info preview-btn d-block w-100 mb-1 text-light">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </li>
                        <li>
                            <button class="btn btn-sm btn-danger delete-btn d-block w-100 text-light">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </li>
                    </ul>
                </span>
                <div class="mt-1">
                    <textarea class="form-control" rows="3" readonly style="max-height: 7.5em; overflow-y: auto;">${noteData.text}</textarea>
                    <span style="font-size: x-small;">${noteDate}</span>
                </div>               
            </div>                       
        </div>
                `;
                // Copy Note Text
                listItem.querySelector(".copy-btn").addEventListener("click", () => {
                    const textToCopy = noteData.text;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        alert("Text copied to clipboard!");
                    }).catch((err) => {
                        alert("Failed to copy text: " + err);
                    });
                });

                // Share Note Text
                listItem.querySelector(".share-btn").addEventListener("click", () => {
                    const textToShare = noteData.text;
                    if (navigator.share) {
                        navigator.share({
                            title: 'Note Share',
                            text: textToShare,
                        }).then(() => {
                            alert("Note shared successfully!"); 
                        }).catch((err) => {
                            alert("Failed to share note: " + err);
                        });
                    } else {
                        alert("Sharing is not supported on your device.");
                    }
                });

                // Edit Note
                listItem.querySelector(".edit-btn").addEventListener("click", () => {
                    editNoteId = noteId;  // Store note ID for editing
                    document.getElementById("modalNoteInput").value = noteData.text;  // Pre-fill modal with note text
                    $('#addNoteModal').modal('show');
                });

                // Preview Note
                listItem.querySelector(".preview-btn").addEventListener("click", () => {
                // Replace newlines with <br> to display text line by line
                const formattedText = noteData.text.replace(/\n/g, '<br>');
                document.getElementById("previewNoteContent").innerHTML = `<p>${formattedText}</p>`;
                   $('#previewNoteModal').modal('show');
                });


                // Delete Note
                listItem.querySelector(".delete-btn").addEventListener("click", () => {
                    if (confirm("Are you sure you want to delete this note?")) {
                        firebase.database().ref("notes/" + firebase.auth().currentUser.uid + "/" + noteId).remove()
                            .then(() => {
                                alert("Note deleted successfully.");
                            })
                            .catch((error) => {
                                alert("Error deleting note: " + error.message);
                            });
                    }
                });

                // Mark/Unmark Note as Important with switch-style checkbox
listItem.querySelector(".important-checkbox").addEventListener("change", (e) => {
    const isImportant = e.target.checked; // Get the new 'important' state
    const notesRef = firebase.database().ref("notes/" + firebase.auth().currentUser.uid);
    notesRef.child(noteId).update({ important: isImportant });
});


                notesList.appendChild(listItem);
            });
        }

        // Load notes and display them
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                const userId = user.uid;
                const notesRef = firebase.database().ref("notes/" + userId);

                loadingSpinner.style.display = "block";
                notesRef.orderByChild("date").on("value", (snapshot) => {
                    loadingSpinner.style.display = "none";
                    notesArray = [];
                    snapshot.forEach((childSnapshot) => {
                        notesArray.unshift(childSnapshot);
                    });
                    renderNotes(); // Render the notes with the current filter
                });
            } else {
                window.location.href = "index.html";
            }
       

                notesList.appendChild(listItem);
            });
        

        

        // Load notes and display them
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                const userId = user.uid;
                const notesRef = firebase.database().ref("notes/" + userId);

                loadingSpinner.style.display = "block";
                notesRef.orderByChild("date").on("value", (snapshot) => {
                    loadingSpinner.style.display = "none";

                    notesArray = [];
                    snapshot.forEach((childSnapshot) => {
                        notesArray.unshift(childSnapshot);
                    });

                    renderNotes(); // Render the notes with the current filter
                });
            } else {
                window.location.href = "index.html";
            }
        });

        // Search filter event listener
        searchInput.addEventListener("input", (e) => {
            const filter = e.target.value;
            renderNotes(filter); // Re-render notes with search filter
        });

         // Log out function
         document.getElementById("logoutButton").addEventListener("click", () => {
            firebase.auth().signOut().then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                alert("Error logging out: " + error.message);
            });
        });

        // back Button
function goBack() {
    if (window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = "defaultPage.html"; // Redirect to a default page
    }
}


    </script>
</body>
</html>
